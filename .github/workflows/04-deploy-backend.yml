name: "04 ¬∑ Deploy Backend"

on:
  push:
    branches: [main]
    paths: ['backend/**']
  workflow_dispatch:
    inputs:
      environment:
        description: 'Target environment'
        required: true
        default: 'dev'
        type: choice
        options: [dev, staging, prod]
      sync_infra:
        description: 'Run Terraform apply to sync Lambda env vars (CORS, etc.)'
        required: false
        default: true
        type: boolean
      credential_notification_enabled:
        description: 'Enable SES credential emails (true/false). Leave empty to keep current.'
        required: false
        default: ''
        type: string
      ses_sender_email:
        description: 'Verified SES sender email. Leave empty to keep current.'
        required: false
        default: ''
        type: string
      platform_login_url:
        description: 'Login URL for credential emails. Leave empty to auto-detect from CloudFront.'
        required: false
        default: ''
        type: string
      platform_name:
        description: 'Platform name for email templates. Leave empty to keep current.'
        required: false
        default: ''
        type: string
      platform_support_email:
        description: 'Support email for notifications. Leave empty to keep current.'
        required: false
        default: ''
        type: string

permissions:
  id-token: write
  contents: read

env:
  TF_VAR_project_name: ${{ vars.PROJECT_NAME || 'license-portal' }}
  TF_VAR_environment: ${{ inputs.environment || 'dev' }}
  TF_VAR_aws_region: ${{ vars.AWS_REGION || 'us-east-1' }}
  TF_VAR_credential_notification_enabled: ${{ vars.CREDENTIAL_NOTIFICATION_ENABLED || 'false' }}
  TF_VAR_ses_sender_email: ${{ vars.SES_SENDER_EMAIL || 'noreply@example.com' }}
  TF_VAR_platform_login_url: ${{ vars.PLATFORM_LOGIN_URL || '' }}
  TF_VAR_platform_name: ${{ vars.PLATFORM_NAME || 'License Portal' }}
  TF_VAR_platform_support_email: ${{ vars.PLATFORM_SUPPORT_EMAIL || 'support@example.com' }}

jobs:
  # ===========================================================================
  # Step 0: Persist workflow inputs as repo variables (self-service config)
  # ===========================================================================
  persist-variables:
    name: Persist Notification Config
    runs-on: ubuntu-latest
    if: >-
      inputs.credential_notification_enabled != '' ||
      inputs.ses_sender_email != '' ||
      inputs.platform_login_url != '' ||
      inputs.platform_name != '' ||
      inputs.platform_support_email != ''
    steps:
      - name: Save inputs as repository variables
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
          REPO: ${{ github.repository }}
        run: |
          set -euo pipefail

          set_var() {
            local name="$1" value="$2"
            if [ -n "$value" ]; then
              echo "Setting $name=$value"
              gh variable set "$name" --repo "$REPO" --body "$value"
            fi
          }

          set_var "CREDENTIAL_NOTIFICATION_ENABLED" "${{ inputs.credential_notification_enabled }}"
          set_var "SES_SENDER_EMAIL" "${{ inputs.ses_sender_email }}"
          set_var "PLATFORM_LOGIN_URL" "${{ inputs.platform_login_url }}"
          set_var "PLATFORM_NAME" "${{ inputs.platform_name }}"
          set_var "PLATFORM_SUPPORT_EMAIL" "${{ inputs.platform_support_email }}"

          echo "### Notification Variables Updated" >> $GITHUB_STEP_SUMMARY
          echo "| Variable | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          [ -n "${{ inputs.credential_notification_enabled }}" ] && echo "| CREDENTIAL_NOTIFICATION_ENABLED | \`${{ inputs.credential_notification_enabled }}\` |" >> $GITHUB_STEP_SUMMARY
          [ -n "${{ inputs.ses_sender_email }}" ] && echo "| SES_SENDER_EMAIL | \`${{ inputs.ses_sender_email }}\` |" >> $GITHUB_STEP_SUMMARY
          [ -n "${{ inputs.platform_login_url }}" ] && echo "| PLATFORM_LOGIN_URL | \`${{ inputs.platform_login_url }}\` |" >> $GITHUB_STEP_SUMMARY
          [ -n "${{ inputs.platform_name }}" ] && echo "| PLATFORM_NAME | \`${{ inputs.platform_name }}\` |" >> $GITHUB_STEP_SUMMARY
          [ -n "${{ inputs.platform_support_email }}" ] && echo "| PLATFORM_SUPPORT_EMAIL | \`${{ inputs.platform_support_email }}\` |" >> $GITHUB_STEP_SUMMARY

  # ===========================================================================
  # Step 1: Sync Infrastructure (Terraform apply for env vars, API Gateway, etc.)
  # ===========================================================================
  sync-infra:
    name: Sync Infrastructure (${{ inputs.environment || 'dev' }})
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment || 'dev' }}
    needs: [persist-variables]
    if: always() && (needs.persist-variables.result == 'success' || needs.persist-variables.result == 'skipped') && inputs.sync_infra != false

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS Credentials (Platform Admin)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.PLATFORM_ADMIN_ROLE_ARN }}
          aws-region: ${{ vars.AWS_REGION || 'us-east-1' }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: "~1.7"

      - name: Ensure State Backend
        run: |
          bash scripts/ensure-state-backend.sh \
            "${{ secrets.TF_STATE_BUCKET }}" \
            "${{ secrets.TF_LOCK_TABLE }}" \
            "${{ vars.AWS_REGION || 'us-east-1' }}"

      - name: Create Lambda Placeholder
        working-directory: infra/control-plane/terraform
        run: |
          echo "placeholder" > lambda-placeholder.txt
          zip lambda-placeholder.zip lambda-placeholder.txt

      - name: Terraform Init
        working-directory: infra/control-plane/terraform
        run: |
          terraform init \
            -backend-config="bucket=${{ secrets.TF_STATE_BUCKET }}" \
            -backend-config="key=platform-admin/${{ inputs.environment || 'dev' }}/terraform.tfstate" \
            -backend-config="region=${{ vars.AWS_REGION || 'us-east-1' }}" \
            -backend-config="dynamodb_table=${{ secrets.TF_LOCK_TABLE }}" \
            -reconfigure

      - name: Terraform Apply (sync env vars and API Gateway)
        working-directory: infra/control-plane/terraform
        run: |
          terraform apply -auto-approve
          echo "### Infrastructure Synced" >> $GITHUB_STEP_SUMMARY
          echo "Lambda environment variables and API Gateway configuration updated." >> $GITHUB_STEP_SUMMARY

  # ===========================================================================
  # Step 2: Build and Deploy Lambda Code
  # ===========================================================================
  deploy:
    name: Deploy Backend (${{ inputs.environment || 'dev' }})
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment || 'dev' }}
    needs: [persist-variables, sync-infra]
    if: always() && (needs.sync-infra.result == 'success' || needs.sync-infra.result == 'skipped') && (needs.persist-variables.result == 'success' || needs.persist-variables.result == 'skipped')

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Dependencies
        working-directory: backend
        run: npm install

      - name: Build
        working-directory: backend
        run: npm run build

      - name: Package Lambda Artifact
        working-directory: backend
        run: |
          set -euo pipefail
          mkdir -p deployment
          cp -r dist deployment/
          cp package.json package-lock.json deployment/
          cd deployment
          npm ci --omit=dev
          zip -r ../lambda-package.zip .

      - name: Configure AWS Credentials (Platform Admin)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.PLATFORM_ADMIN_ROLE_ARN }}
          aws-region: ${{ vars.AWS_REGION || 'us-east-1' }}

      - name: Deploy to Lambda
        env:
          FUNCTION_NAME: ${{ vars.PROJECT_NAME || 'license-portal' }}-${{ inputs.environment || 'dev' }}-backend
        run: |
          set -euo pipefail
          
          # Update function code
          aws lambda update-function-code \
            --function-name "${FUNCTION_NAME}" \
            --zip-file fileb://backend/lambda-package.zip \
            --publish
          
          # Wait for update to complete
          aws lambda wait function-updated-v2 \
            --function-name "${FUNCTION_NAME}"
          
          # Get latest version
          LATEST_VERSION=$(aws lambda list-versions-by-function \
            --function-name "${FUNCTION_NAME}" \
            --query "Versions[-1].Version" \
            --output text)
          
          # Update live alias for zero-downtime
          aws lambda update-alias \
            --function-name "${FUNCTION_NAME}" \
            --name live \
            --function-version "${LATEST_VERSION}"
          
          echo "Deployed version ${LATEST_VERSION} to ${FUNCTION_NAME}"
          echo "### Backend Deployed" >> $GITHUB_STEP_SUMMARY
          echo "| Detail | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Function | \`${FUNCTION_NAME}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Version | \`${LATEST_VERSION}\` |" >> $GITHUB_STEP_SUMMARY

      - name: Verify Lambda Configuration
        env:
          FUNCTION_NAME: ${{ vars.PROJECT_NAME || 'license-portal' }}-${{ inputs.environment || 'dev' }}-backend
        run: |
          set -euo pipefail
          echo "üîç Verifying Lambda configuration..."
          CONFIG=$(aws lambda get-function-configuration --function-name "${FUNCTION_NAME}" --query '{Handler: Handler, Runtime: Runtime, MemorySize: MemorySize, Timeout: Timeout, CodeSize: CodeSize, LastModified: LastModified}' --output json)
          echo "${CONFIG}" | jq .

          HANDLER=$(echo "${CONFIG}" | jq -r '.Handler')
          if [ "${HANDLER}" != "dist/main.handler" ]; then
            echo "::error::Handler mismatch: expected 'dist/main.handler', got '${HANDLER}'"
            exit 1
          fi
          echo "‚úÖ Handler verified: ${HANDLER}"
