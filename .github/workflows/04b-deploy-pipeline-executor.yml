name: "04b ¬∑ Deploy Pipeline Executor"

on:
  push:
    branches: [main]
    paths: ['backend/**']
  workflow_dispatch:
    inputs:
      environment:
        description: 'Target environment'
        required: true
        default: 'dev'
        type: choice
        options: [dev, staging, prod]

permissions:
  id-token: write
  contents: read

jobs:
  deploy:
    name: Deploy Pipeline Executor (${{ inputs.environment || 'dev' }})
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment || 'dev' }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Dependencies
        working-directory: backend
        run: npm install

      - name: Build
        working-directory: backend
        run: npm run build

      - name: Verify Pipeline Executor Handler
        working-directory: backend
        run: |
          set -euo pipefail
          if [ ! -f dist/pipeline-executor.handler.js ]; then
            echo "::error::dist/pipeline-executor.handler.js not found ‚Äî nest build may not have compiled it"
            exit 1
          fi
          echo "‚úÖ pipeline-executor.handler.js present in dist/"

      - name: Package Lambda Artifact
        working-directory: backend
        run: |
          set -euo pipefail
          mkdir -p deployment
          cp -r dist deployment/
          cp package.json package-lock.json deployment/
          cd deployment
          npm ci --omit=dev
          zip -r ../lambda-package.zip .

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.PLATFORM_ADMIN_ROLE_ARN }}
          aws-region: ${{ vars.AWS_REGION || 'us-east-1' }}

      - name: Deploy Pipeline Executor Lambda
        env:
          FUNCTION_NAME: ${{ vars.PROJECT_NAME || 'license-portal' }}-${{ inputs.environment || 'dev' }}-pipeline-executor
        run: |
          set -euo pipefail
          
          echo "Deploying pipeline executor: ${FUNCTION_NAME}"
          
          # Update function code
          aws lambda update-function-code \
            --function-name "${FUNCTION_NAME}" \
            --zip-file fileb://backend/lambda-package.zip \
            --publish

          # Ensure handler points to compiled entry point
          aws lambda update-function-configuration \
            --function-name "${FUNCTION_NAME}" \
            --handler "dist/pipeline-executor.handler.handler" \
            --runtime "nodejs20.x"

          # Wait for update to complete
          aws lambda wait function-updated-v2 \
            --function-name "${FUNCTION_NAME}"
          
          # Get latest version
          LATEST_VERSION=$(aws lambda list-versions-by-function \
            --function-name "${FUNCTION_NAME}" \
            --query "Versions[-1].Version" \
            --output text)
          
          # Update live alias for zero-downtime
          aws lambda update-alias \
            --function-name "${FUNCTION_NAME}" \
            --name live \
            --function-version "${LATEST_VERSION}"
          
          echo "‚úÖ Pipeline executor deployed: version ${LATEST_VERSION}"

      - name: Verify Lambda Configuration
        env:
          FUNCTION_NAME: ${{ vars.PROJECT_NAME || 'license-portal' }}-${{ inputs.environment || 'dev' }}-pipeline-executor
        run: |
          set -euo pipefail
          echo "üîç Verifying Lambda configuration..."
          CONFIG=$(aws lambda get-function-configuration --function-name "${FUNCTION_NAME}" --query '{Handler: Handler, Runtime: Runtime, MemorySize: MemorySize, Timeout: Timeout, CodeSize: CodeSize, LastModified: LastModified}' --output json)
          echo "${CONFIG}" | jq .
          
          HANDLER=$(echo "${CONFIG}" | jq -r '.Handler')
          if [ "${HANDLER}" != "dist/pipeline-executor.handler.handler" ]; then
            echo "::error::Handler mismatch: expected 'dist/pipeline-executor.handler.handler', got '${HANDLER}'"
            exit 1
          fi
          echo "‚úÖ Handler verified: ${HANDLER}"
